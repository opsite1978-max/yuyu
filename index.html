<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æŒ‡æ±ºç­–æ ¸å¿ƒ V7.0</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --input-bg: #334155; --text: #f1f5f9; --red: #ef4444; --green: #10b981; --gold: #f59e0b; --blue: #3b82f6; --purple: #a855f7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 120px; }
        .container { max-width: 550px; margin: 0 auto; background: var(--card); border-radius: 16px; border: 1px solid #475569; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .header { background: linear-gradient(to right, #0f172a, #1e293b); padding: 20px; text-align: center; border-bottom: 1px solid #334155; }
        h1 { margin: 0; font-size: 20px; font-weight: 800; letter-spacing: 1px; color: #fff; }
        .subtitle { font-size: 12px; color: #94a3b8; margin-top: 5px; }

        .btn-group { padding: 15px; display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-auto { background: var(--blue); }
        .btn-clear { background: #475569; max-width: 80px; }

        .section { padding: 0 20px 15px 20px; }
        .section-title { font-size: 12px; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .section-title::before { content: ''; width: 3px; height: 12px; background: var(--blue); display: block; }
        
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        label { display: block; font-size: 11px; color: #cbd5e1; margin-bottom: 4px; }
        input { width: 100%; background: var(--input-bg); border: 1px solid #475569; color: white; padding: 12px; border-radius: 8px; font-size: 18px; font-weight: 700; text-align: center; outline: none; box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: var(--blue); background: #1e293b; transform: scale(1.02); }
        
        /* ç‰¹æ®Šè¼¸å…¥æ¡†æ¨£å¼ */
        .hl-input input { border-color: var(--gold); background: #422006; color: #fbbf24; } 
        .main-force-input input { border-color: var(--purple); background: #3b0764; color: #d8b4fe; font-size: 20px; } /* ä¸»åŠ›å°ˆç”¨è‰² */
        .long-input input { border-color: var(--red); background: #450a0a; }
        .short-input input { border-color: var(--green); background: #064e3b; }

        /* å„€è¡¨æ¿ */
        .dashboard { background: #020617; padding: 20px; margin: 20px; border-radius: 12px; border: 1px solid #1e293b; text-align: center; }
        .verdict { font-size: 28px; font-weight: 900; margin-bottom: 5px; }
        .confidence { font-size: 13px; color: #94a3b8; margin-bottom: 15px; }
        .progress-bar { height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-bottom: 15px; }
        .progress-fill { height: 100%; width: 50%; transition: 0.5s; }

        .target-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .target-card { background: #1e293b; border: 1px solid #334155; padding: 10px; border-radius: 8px; text-align: center; }
        .target-label { font-size: 11px; color: #94a3b8; }
        .target-price { font-size: 20px; font-weight: 800; margin-top: 2px; }

        .spread-box { text-align: center; font-size: 12px; padding: 5px; background: #0f172a; border-radius: 4px; margin-bottom: 10px; color: #64748b; }
        .red-text { color: var(--red); }
        .green-text { color: var(--green); }
        .gray-text { color: #94a3b8; }
        #loading { display: none; margin-left: 5px; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸš€ å°æŒ‡æ±ºç­–æ ¸å¿ƒ V7.0</h1>
        <div class="subtitle">ä¸»åŠ›ç¸½å’Œ â€¢ æ¥µé€Ÿè¼¸å…¥ â€¢ æ™ºèƒ½é‹ç®—</div>
    </div>

    <div class="btn-group">
        <button class="btn btn-auto" onclick="autoFetch()">
            âš¡ æŠ“å–å¤§ç›¤/æ³¢å‹• <span id="loading">â†»</span>
        </button>
        <button class="btn btn-clear" onclick="clearData()">ğŸ—‘ï¸</button>
    </div>

    <div class="section">
        <div class="section-title">1. åƒ¹æ ¼èˆ‡å‹•èƒ½</div>
        <div class="row">
            <div class="col">
                <label>åŠ æ¬ŠæŒ‡æ•¸</label>
                <input type="number" id="spot" disabled placeholder="è‡ªå‹•">
            </div>
            <div class="col">
                <label>ATR æ³¢å‹•</label>
                <input type="number" id="atr" oninput="calc()">
            </div>
        </div>
        <div class="row">
            <div class="col hl-input">
                <label>ğŸ“ å°æŒ‡æœŸ (åŸºæº–)</label>
                <input type="number" id="tx" placeholder="è¼¸å…¥é»æ•¸" oninput="calc()">
            </div>
        </div>
        <div id="spread-display" class="spread-box">ç­‰å¾…è¼¸å…¥å°æŒ‡æœŸ...</div>
    </div>

    <div class="section">
        <div class="section-title">2. ä¸»åŠ›ç±Œç¢¼ (Big Money)</div>
        <div class="row">
            <div class="col main-force-input">
                <label>ğŸ¦ ä¸»åŠ›/æ³•äºº åˆè¨ˆæ·¨å£æ•¸</label>
                <input type="number" id="main_force" placeholder="ä¾‹å¦‚ -15000" oninput="calc()">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label>ğŸ›¡ï¸ P/C Ratio (%)</label>
                <input type="number" id="pc" placeholder="105" oninput="calc()">
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">3. æ•£æˆ¶æŒ‡æ¨™ (åå‘)</div>
        <div class="row">
            <div class="col long-input">
                <label>å°å°-å¤šå–®</label>
                <input type="number" id="mtx_long" placeholder="å¤šå–®é‡" oninput="calc()">
            </div>
            <div class="col short-input">
                <label>å°å°-ç©ºå–®</label>
                <input type="number" id="mtx_short" placeholder="ç©ºå–®é‡" oninput="calc()">
            </div>
        </div>
        <div class="row">
            <div class="col long-input">
                <label>å¾®å°-å¤šå–®</label>
                <input type="number" id="tmf_long" placeholder="å¤šå–®é‡" oninput="calc()">
            </div>
            <div class="col short-input">
                <label>å¾®å°-ç©ºå–®</label>
                <input type="number" id="tmf_short" placeholder="ç©ºå–®é‡" oninput="calc()">
            </div>
        </div>
    </div>

    <div class="dashboard">
        <div id="verdict" class="verdict gray-text">ç­‰å¾…æ•¸æ“š</div>
        <div id="confidence" class="confidence">è«‹å¡«å¯«æ•¸æ“šä»¥é€²è¡Œ AI åˆ¤è®€</div>
        
        <div class="progress-bar">
            <div id="prob-bar" class="progress-fill" style="background:#64748b; width:50%;"></div>
        </div>

        <div class="target-grid" id="targets" style="opacity:0.3">
            <div class="target-card">
                <div class="target-label">ç¬¬ä¸€ç›®æ¨™ (ATR 1.0)</div>
                <div class="target-price" id="tp1">--</div>
            </div>
            <div class="target-card">
                <div class="target-label">ç¬¬äºŒç›®æ¨™ (Fib 1.618)</div>
                <div class="target-price" id="tp2">--</div>
            </div>
        </div>
    </div>
</div>

<script>
    const ids = ['spot', 'atr', 'tx', 'main_force', 'pc', 'mtx_long', 'mtx_short', 'tmf_long', 'tmf_short'];

    window.onload = () => {
        ids.forEach(id => {
            const v = localStorage.getItem(id);
            if(v) document.getElementById(id).value = v;
        });
        calc();
    };

    async function autoFetch() {
        const icon = document.getElementById('loading');
        icon.style.display = 'inline-block';
        try {
            const ts = new Date().getTime();
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/%5ETWII?interval=1d&range=5d&_=' + ts)}`);
            const data = await res.json();
            const result = JSON.parse(data.contents).chart.result[0];
            const quotes = result.indicators.quote[0];
            const last = result.meta.regularMarketPrice;

            let sum = 0, count = 0;
            for(let i=0; i<quotes.high.length; i++) {
                if(quotes.high[i]) { sum += (quotes.high[i] - quotes.low[i]); count++; }
            }
            const atr = count ? Math.round(sum/count) : 300;

            document.getElementById('spot').value = Math.round(last);
            document.getElementById('atr').value = atr;
            
            if(!document.getElementById('tx').value) document.getElementById('tx').value = Math.round(last);

            calc();
        } catch(e) { alert('æŠ“å–å¤±æ•—'); }
        icon.style.display = 'none';
    }

    function calc() {
        // Save
        ids.forEach(id => {
            const el = document.getElementById(id);
            localStorage.setItem(id, el.value);
        });

        // Values
        const tx = parseInt(document.getElementById('tx').value);
        const spot = parseInt(document.getElementById('spot').value);
        const atr = parseInt(document.getElementById('atr').value) || 250;
        
        // ä¸»åŠ›ç›´æ¥å–ç”¨å–®ä¸€æ¬„ä½
        const main_force = parseInt(document.getElementById('main_force').value) || 0;
        
        const pc = parseFloat(document.getElementById('pc').value) || 100;
        
        // æ•£æˆ¶ç´°é …
        const mtx_L = parseInt(document.getElementById('mtx_long').value) || 0;
        const mtx_S = parseInt(document.getElementById('mtx_short').value) || 0;
        const tmf_L = parseInt(document.getElementById('tmf_long').value) || 0;
        const tmf_S = parseInt(document.getElementById('tmf_short').value) || 0;
        
        const retail_net = (mtx_L - mtx_S) + ((tmf_L - tmf_S) * 0.2);

        // --- æ ¸å¿ƒè©•åˆ† V7.0 ---
        let score = 0; 
        let reasons = [];

        // 1. ä¸»åŠ›æ¬Šé‡ (æœ€é‡è¦)
        if (main_force > 10000) score += 35;
        else if (main_force > 3000) score += 15;
        else if (main_force < -10000) score -= 35; 
        else if (main_force < -3000) score -= 15;

        // 2. æ•£æˆ¶æ¬Šé‡ (åå‘)
        if (retail_net > 3000) score -= 25; 
        else if (retail_net > 1500) score -= 10;
        else if (retail_net < -3000) score += 25; 
        else if (retail_net < -1500) score += 10;

        // 3. P/C Ratio
        if (pc > 110) score += 15;
        else if (pc < 90) score -= 15;

        // 4. åƒ¹å·®
        if (tx && spot) {
            let spread = tx - spot;
            document.getElementById('spread-display').innerText = `åƒ¹å·®ï¼š${spread > 0 ? '+' : ''}${spread}`;
            document.getElementById('spread-display').className = spread > 0 ? 'spread-box red-text' : 'spread-box green-text';
            if (spread > 80) score += 5; 
            else if (spread < -80) score -= 5; 
        }

        // --- è¼¸å‡º ---
        const verdict = document.getElementById('verdict');
        const conf = document.getElementById('confidence');
        const bar = document.getElementById('prob-bar');
        const targets = document.getElementById('targets');

        if (!tx) return;

        targets.style.opacity = "1";
        
        let prob = 50 + (score / 1.8);
        if (prob > 95) prob = 95;
        if (prob < 5) prob = 5;

        if (score >= 20) {
            verdict.innerText = "ğŸš€ åå¤šæ“ä½œ";
            verdict.className = "verdict red-text";
            conf.innerText = `ä¸»åŠ›(${main_force}) åšå¤šï¼ŒAI å‹ç‡é ä¼°ï¼š${prob.toFixed(0)}%`;
            bar.style.background = `linear-gradient(to right, #ef4444 ${prob}%, #333 ${prob}%)`;
            
            document.getElementById('tp1').innerText = Math.round(tx + atr);
            document.getElementById('tp1').style.color = "#ef4444";
            document.getElementById('tp2').innerText = Math.round(tx + atr * 1.618);
            document.getElementById('tp2').style.color = "#ef4444";

        } else if (score <= -20) {
            verdict.innerText = "ğŸ“‰ åç©ºæ“ä½œ";
            verdict.className = "verdict green-text";
            conf.innerText = `ä¸»åŠ›(${main_force}) åšç©ºï¼ŒAI å‹ç‡é ä¼°ï¼š${(100-prob).toFixed(0)}%`;
            bar.style.background = `linear-gradient(to right, #10b981 ${100-prob}%, #333 ${100-prob}%)`;

            document.getElementById('tp1').innerText = Math.round(tx - atr);
            document.getElementById('tp1').style.color = "#10b981";
            document.getElementById('tp2').innerText = Math.round(tx - atr * 1.618);
            document.getElementById('tp2').style.color = "#10b981";

        } else {
            verdict.innerText = "âš–ï¸ å€é–“éœ‡ç›ª";
            verdict.className = "verdict gray-text";
            conf.innerText = "ä¸»åŠ›æ–¹å‘ä¸æ˜æˆ–èˆ‡æ•£æˆ¶æŠµéŠ·ï¼Œå»ºè­°è§€æœ›";
            bar.style.background = "#64748b";
            
            document.getElementById('tp1').innerText = Math.round(tx + atr * 0.5);
            document.getElementById('tp1').style.color = "#cbd5e1";
            document.getElementById('tp2').innerText = Math.round(tx - atr * 0.5);
            document.getElementById('tp2').style.color = "#cbd5e1";
        }
    }
</script>

</body>
</html>
